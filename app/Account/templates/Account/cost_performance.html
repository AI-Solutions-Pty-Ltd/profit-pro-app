{% extends "base.html" %}
{% load static %}
{% block title %}
    Cost Performance Report
{% endblock title %}
{% block extra_css %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
          rel="stylesheet">
    <style>
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    .metric-card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
        margin-bottom: 1.5rem;
    }
    .metric-card:hover {
        transform: translateY(-5px);
    }
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
    }
    .metric-label {
        font-size: 0.9rem;
        color: #fffffff;
    }
    .positive {
        color: #28a745;
    }
    .negative {
        color: #dc3545;
    }
    .neutral {
        color: #ffc107;
    }
    .table-custom {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
    }
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 500;
    }
    .project-row {
        transition: background-color 0.2s;
    }
    .project-row:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }
    .urgent-intervention {
        background-color: #f8d7da !important;
    }
    .requires-attention {
        background-color: #fff3cd !important;
    }
    .performing-as-planned {
        background-color: #d1e7dd !important;
    }
    </style>
{% endblock extra_css %}
{% block content %}
    <div class="dashboard-header">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="md:w-1/2">
                    <h1 class="text-3xl font-bold mb-2">
                        <i class="fas fa-dollar-sign mr-3"></i>Cost Performance Report
                    </h1>
                    <p class="mb-0">Detailed project cost analysis and performance metrics</p>
                </div>
                <div class="md:w-1/2 md:text-right mt-4 md:mt-0">
                    <h4 class="text-xl font-semibold">
                        <i class="fas fa-calendar mr-2"></i>{{ report_date }}
                    </h4>
                    <p class="mb-0">Report Date</p>
                </div>
            </div>
        </div>
    </div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Key Metrics Row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 text-white">
            <div class="metric-card bg-blue-600 text-white rounded-lg shadow-lg p-6 hover:transform hover:-translate-y-1 transition-transform duration-200">
                <div class="text-center">
                    <i class="fas fa-project-diagram text-4xl mb-4"></i>
                    <div class="metric-value text-3xl font-bold">{{ projects|length }}</div>
                    <div class="metric-label text-sm">Total Projects</div>
                </div>
            </div>
            <div class="metric-card bg-red-600 text-white rounded-lg shadow-lg p-6 hover:transform hover:-translate-y-1 transition-transform duration-200">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                    <div class="metric-value text-3xl font-bold">{{ status_counts.urgent_intervention }}</div>
                    <div class="metric-label text-sm">Urgent Interventions</div>
                </div>
            </div>
            <div class="metric-card bg-yellow-600 text-white rounded-lg shadow-lg p-6 hover:transform hover:-translate-y-1 transition-transform duration-200">
                <div class="text-center">
                    <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                    <div class="metric-value text-3xl font-bold">{{ status_counts.requires_attention }}</div>
                    <div class="metric-label text-sm">Requires Attention</div>
                </div>
            </div>
            <div class="metric-card bg-green-600 text-white rounded-lg shadow-lg p-6 hover:transform hover:-translate-y-1 transition-transform duration-200">
                <div class="text-center">
                    <i class="fas fa-check-circle text-4xl mb-4"></i>
                    <div class="metric-value text-3xl font-bold">{{ status_counts.performing_as_planned }}</div>
                    <div class="metric-label text-sm">Performing as Planned</div>
                </div>
            </div>
        </div>
        <!-- Portfolio Summary -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="bg-white border-b border-gray-200 px-6 py-4">
                    <h5 class="text-lg font-semibold mb-0">
                        <i class="fas fa-chart-pie mr-2"></i>Portfolio Summary
                    </h5>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div>
                            <h6 class="text-sm font-medium text-gray-500 mb-2">Approved Contract Amount</h6>
                            <h4 class="text-2xl font-bold text-blue-600">R{{ totals.approved_contract_amount|floatformat:"2g" }}</h4>
                        </div>
                        <div>
                            <h6 class="text-sm font-medium text-gray-500 mb-2">Actual Cumulative Work</h6>
                            <h4 class="text-2xl font-bold text-green-600">R{{ totals.actual_cumulative_work|floatformat:"2g" }}</h4>
                        </div>
                        <div>
                            <h6 class="text-sm font-medium text-gray-500 mb-2">Forecast Cost at Completion</h6>
                            <h4 class="text-2xl font-bold text-yellow-600">R{{ totals.forecast_cost_at_completion|floatformat:"2g" }}</h4>
                        </div>
                        <div>
                            <h6 class="text-sm font-medium text-gray-500 mb-2">Total Overrun/Saving</h6>
                            <h4 class="text-2xl font-bold {% if totals.overrun_saving > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                R{{ totals.overrun_saving|floatformat:"2g" }}
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Project Cost Table -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="bg-white border-b border-gray-200 px-6 py-4">
                    <h5 class="text-lg font-semibold mb-0">
                        <i class="fas fa-table mr-2"></i>Portfolio Cost Performance Report
                    </h5>
                </div>
                <div class="p-6">
                    <div class="overflow-x-auto max-h-96 overflow-y-auto">
                        <table class="w-full border-collapse text-xs fs-8">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Project Name</th>
                                    <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">
                                        Approved Contract Amount
                                    </th>
                                    <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">
                                        Planned Cumulative Work
                                    </th>
                                    <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">
                                        Actual Cumulative Work
                                    </th>
                                    <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">
                                        Forecast Cost at Completion
                                    </th>
                                    <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Overrun Saving</th>
                                    <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">% Overrun Saving</th>
                                    <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">
                                        Actual as % of Approved
                                    </th>
                                    <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">
                                        Cost Performance Index
                                    </th>
                                    <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">
                                        % Variance Actual & Planned
                                    </th>
                                    <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Lead Consultant</th>
                                    <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Contractor</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for project in projects %}
                                    <tr class="project-row {{ project.status }} hover:bg-gray-50 cursor-pointer"
                                        onclick="viewProjectDetails({{ project.id }})">
                                        <td class="px-2 py-1 whitespace-nowrap text-sm font-medium text-gray-900">
                                            <strong>{{ project.name }}</strong>
                                        </td>
                                        <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-500">
                                            R{{ project.approved_contract_amount|floatformat:"2g" }}
                                        </td>
                                        <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-500">
                                            R{{ project.planned_cumulative_work|floatformat:"2g" }}
                                        </td>
                                        <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-500">
                                            R{{ project.actual_cumulative_work|floatformat:"2g" }}
                                        </td>
                                        <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-500">
                                            R{{ project.forecast_cost_at_completion|floatformat:"2g" }}
                                        </td>
                                        <td class="px-2 py-1 whitespace-nowrap text-sm {% if project.overrun_saving > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                            R{{ project.overrun_saving|floatformat:"2g" }}
                                        </td>
                                        <td class="px-2 py-1 whitespace-nowrap text-sm {% if project.percent_overrun_saving > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                            {{ project.percent_overrun_saving }}%
                                        </td>
                                        <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-500">
                                            <div class="w-full bg-gray-200 rounded-full h-2">
                                                <div class="bg-blue-600 h-2 rounded-full"
                                                     style="width: {{ project.actual_as_percent_approved }}%"></div>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1">{{ project.actual_as_percent_approved }}%</div>
                                        </td>
                                        <td class="px-2 py-1 whitespace-nowrap text-sm {% if project.cost_performance_index >= 1 %}text-green-600{% else %}text-red-600{% endif %}">
                                            {{ project.cost_performance_index }}
                                        </td>
                                        <td class="px-2 py-1 whitespace-nowrap text-sm {% if project.percent_variance_actual_planned > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                            {{ project.percent_variance_actual_planned }}%
                                        </td>
                                        <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-500">{{ project.lead_consultant }}</td>
                                        <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-500">{{ project.contractor }}</td>
                                    </tr>
                                {% endfor %}
                                <!-- Totals Row -->
                                <tr class="bg-gray-100 font-bold">
                                    <td class="px-2 py-1 whitespace-nowrap text-sm font-medium text-gray-900">
                                        <strong>TOTALS</strong>
                                    </td>
                                    <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-500">
                                        R{{ totals.approved_contract_amount|floatformat:"2g" }}
                                    </td>
                                    <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-500">
                                        R{{ totals.planned_cumulative_work|floatformat:"2g" }}
                                    </td>
                                    <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-500">
                                        R{{ totals.actual_cumulative_work|floatformat:"2g" }}
                                    </td>
                                    <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-500">
                                        R{{ totals.forecast_cost_at_completion|floatformat:"2g" }}
                                    </td>
                                    <td class="px-2 py-1 whitespace-nowrap text-sm {% if totals.overrun_saving > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                        R{{ totals.overrun_saving|floatformat:"2g" }}
                                    </td>
                                    <td class="px-2 py-1 whitespace-nowrap text-sm {% if totals.percent_overrun_saving > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                        {{ totals.percent_overrun_saving }}%
                                    </td>
                                    <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-500">
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-blue-600 h-2 rounded-full"
                                                 style="width: {{ totals.actual_as_percent_approved }}%"></div>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">{{ totals.actual_as_percent_approved }}%</div>
                                    </td>
                                    <td class="px-2 py-1 whitespace-nowrap text-sm {% if totals.cost_performance_index >= 1 %}text-green-600{% else %}text-red-600{% endif %}">
                                        {{ totals.cost_performance_index }}
                                    </td>
                                    <td class="px-2 py-1 whitespace-nowrap text-sm {% if totals.percent_variance_actual_planned > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                        {{ totals.percent_variance_actual_planned }}%
                                    </td>
                                    <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-500">-</td>
                                    <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-500">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Status Legend -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="bg-white border-b border-gray-200 px-6 py-4">
                    <h5 class="text-lg font-semibold mb-0">
                        <i class="fas fa-info-circle mr-2"></i>Project Status Classification
                    </h5>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="flex items-start">
                            <div class="urgent-intervention p-2 mr-3 rounded flex-shrink-0 w-8 h-8"></div>
                            <div>
                                <strong>Urgent Interventions</strong>
                                <br>
                                <small class="text-gray-500">Variance in either column G or J is greater than 5%</small>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="requires-attention p-2 mr-3 rounded flex-shrink-0 w-8 h-8"></div>
                            <div>
                                <strong>Requires Attention</strong>
                                <br>
                                <small class="text-gray-500">Variance in either column G or J is greater than 0% but less than 5%</small>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="performing-as-planned p-2 mr-3 rounded flex-shrink-0 w-8 h-8"></div>
                            <div>
                                <strong>Performing as Planned</strong>
                                <br>
                                <small class="text-gray-500">Variance in columns G and J are less than 0%</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Back to Dashboard -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="p-6 text-center">
                    <a href="{% url 'account:dashboard' %}"
                       class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block extra_js %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Cost Performance Report loaded successfully');
    });
    
    // Function to view project details
    function viewProjectDetails(projectId) {
        alert(`Project details view would be implemented here for Project ${projectId}.\n\nThis would show detailed cost breakdowns, budget allocations, spending trends, and financial history.`);
    }
    </script>
{% endblock extra_js %}
