{% extends "base_full.html" %}
{% block title %}
    Payment Certificate - {{ project.name }}
{% endblock title %}
{% block content %}
    <style>
      .header {
          font-weight: bold;
          background-color: #f5f5f5;
          padding: 8px;
      }

      .header:hover {
          background-color: #e5e5e5;
      }
    </style>
    <!-- Header -->
    <div class="bg-white shadow-sm rounded-lg mb-6">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">{{ project.name }}</h1>
                    <p class="text-sm text-gray-600 mt-1">Payment Certificate: #{{ payment_certificate.certificate_number }}</p>
                    <p class="text-sm text-gray-600 mt-1">Status: {{ payment_certificate.status }}</p>
                    <p class="text-sm text-gray-600 mt-1">Date: {{ payment_certificate.approved_on }}</p>
                </div>
                <div class="flex items-center space-x-3">
                    {% if payment_certificate.status == "DRAFT" %}
                        <a href="{% url 'bill_of_quantities:payment-certificate-edit' project.pk payment_certificate.pk %}"
                           class="loading-btn inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                           data-loading-text="Editing...">
                            {% heroicon_outline "pencil" class="w-4 h-4" %}
                            Edit
                        </a>
                    {% endif %}
                    {% if payment_certificate.actual_transactions.count %}
                        {% if payment_certificate.status == 'DRAFT' or payment_certificate.status == 'REJECTED' %}
                            <a href="{% url 'bill_of_quantities:payment-certificate-submit' project.pk payment_certificate.pk %}"
                               class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                {% heroicon_outline "check" class="w-4 h-4" %}
                                Submit Payment Certificate
                            </a>
                        {% endif %}
                    {% endif %}
                    {% if payment_certificate.status == 'SUBMITTED' %}
                        <span class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-amber-700 bg-amber-50 rounded-md border border-amber-200">
                            {% heroicon_outline "clock" class="w-4 h-4 mr-1" %}
                            Awaiting Client Approval
                        </span>
                    {% endif %}
                    {% if payment_certificate.is_final %}
                        <a href="{% url 'bill_of_quantities:final-account-detail' project.pk payment_certificate.pk %}"
                           class="inline-flex items-center px-3 py-2 border border-emerald-300 shadow-sm text-sm leading-4 font-medium rounded-md text-emerald-700 bg-emerald-50 hover:bg-emerald-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                            {% heroicon_outline "document-check" class="w-4 h-4 mr-1" %}
                            View Final Account
                        </a>
                    {% endif %}
                    {% if payment_certificate.status == 'APPROVED' %}
                        {% if project.signatories.count > 0 %}
                            <form method="post"
                                  action="{% url 'bill_of_quantities:payment-certificate-email' project.pk payment_certificate.pk %}">
                                {% csrf_token %}
                                <button type="submit"
                                        class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    {% heroicon_outline "envelope" class="w-4 h-4" %}
                                    Email to Signatories
                                </button>
                            </form>
                        {% else %}
                            <a href="{% url 'project:signatory-list' project.pk %}"
                               class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                {% heroicon_outline "plus" class="w-4 h-4" %}
                                Add signatories to send email
                            </a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            <div id="pdf-download" class="mt-6 pt-6 border-t border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Download PDF Reports</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Full PDF Form -->
                    <form method="get"
                          class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:border-indigo-300 transition-colors"
                          action="{% url 'bill_of_quantities:payment-certificate-download-pdf' project.pk payment_certificate.pk %}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <h3 class="text-sm font-semibold text-gray-900">Full Payment Certificate</h3>
                                    {% if payment_certificate.pdf_generating %}
                                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                            <svg class="animate-spin h-3 w-3"
                                                 xmlns="http://www.w3.org/2000/svg"
                                                 fill="none"
                                                 viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                                </path>
                                            </svg>
                                            Generating...
                                        </span>
                                    {% elif payment_certificate.pdf %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            ✓ Available
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            Not generated
                                        </span>
                                    {% endif %}
                                </div>
                                <p class="text-xs text-gray-600 mt-1">Complete certificate with all line items</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="flex items-center text-xs text-gray-700 cursor-pointer">
                                <input type="checkbox"
                                       name="force"
                                       value="true"
                                       id="force-full-pdf"
                                       class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2">
                                <span>Force regenerate</span>
                            </label>
                            <button type="submit"
                                    id="full-pdf-button"
                                    {% if payment_certificate.pdf_generating %}disabled{% endif %}
                                    class="inline-flex items-center gap-2 px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white {% if payment_certificate.pdf_generating %}bg-gray-400 cursor-not-allowed{% else %}bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500{% endif %} transition-colors">
                                {% heroicon_outline "arrow-down-tray" class="w-4 h-4" %}
                                <span id="full-pdf-button-text">Download</span>
                            </button>
                        </div>
                    </form>
                    <!-- Abridged PDF Form -->
                    <form method="get"
                          class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:border-indigo-300 transition-colors"
                          action="{% url 'bill_of_quantities:payment-certificate-download-abridged-pdf' project.pk payment_certificate.pk %}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <h3 class="text-sm font-semibold text-gray-900">Abridged Certificate</h3>
                                    {% if payment_certificate.abridged_pdf_generating %}
                                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                            <svg class="animate-spin h-3 w-3"
                                                 xmlns="http://www.w3.org/2000/svg"
                                                 fill="none"
                                                 viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                                </path>
                                            </svg>
                                            Generating...
                                        </span>
                                    {% elif payment_certificate.abridged_pdf %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            ✓ Available
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            Not generated
                                        </span>
                                    {% endif %}
                                </div>
                                <p class="text-xs text-gray-600 mt-1">Summary with claimed items only</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="flex items-center text-xs text-gray-700 cursor-pointer">
                                <input type="checkbox"
                                       name="force"
                                       value="true"
                                       id="force-abridged-pdf"
                                       class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2">
                                <span>Force regenerate</span>
                            </label>
                            <button type="submit"
                                    id="abridged-pdf-button"
                                    {% if payment_certificate.abridged_pdf_generating %}disabled{% endif %}
                                    class="inline-flex items-center gap-2 px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white {% if payment_certificate.abridged_pdf_generating %}bg-gray-400 cursor-not-allowed{% else %}bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500{% endif %} transition-colors">
                                {% heroicon_outline "arrow-down-tray" class="w-4 h-4" %}
                                <span id="abridged-pdf-button-text">Download</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Invoice and Statement Section -->
            <div id="invoice-statement" class="mt-6 pt-6 border-t border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Client Documents</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Invoice -->
                    <a href="{% url 'bill_of_quantities:payment-certificate-invoice' project.pk payment_certificate.pk %}"
                       target="_blank"
                       class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:border-indigo-300 transition-colors block">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <h3 class="text-sm font-semibold text-gray-900">Invoice</h3>
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        {% heroicon_outline "document" class="w-3 h-3" %}
                                        PDF Available
                                    </span>
                                </div>
                                <p class="text-xs text-gray-600 mt-1">Client invoice for payment</p>
                            </div>
                            {% heroicon_outline "arrow-down-tray" class="w-5 h-5 text-gray-400" %}
                        </div>
                    </a>
                    <!-- Payment Statement -->
                    <a href="{% url 'bill_of_quantities:payment-certificate-payment-statement' project.pk payment_certificate.pk %}"
                       class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:border-indigo-300 transition-colors block">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <h3 class="text-sm font-semibold text-gray-900">Payment Statement</h3>
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        {% heroicon_outline "document-text" class="w-3 h-3" %}
                                        Interactive
                                    </span>
                                </div>
                                <p class="text-xs text-gray-600 mt-1">View payment history and balance</p>
                            </div>
                            {% heroicon_outline "arrow-right" class="w-5 h-5 text-gray-400" %}
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- Transactions Preview -->
    <div class="bg-white shadow-sm rounded-lg mb-6 px-6 py-4 ">
        <div class="border-b border-gray-200 mb-4">
            <h2 class="text-lg font-bold text-gray-900">Transactions</h2>
            <p class="text-sm text-gray-600 mb-2">Review the transactions before approving</p>
        </div>
        <div id="contract-line-items" class="mb-6 border-b border-gray-200">
            <h2 class="text-lg font-bold text-gray-900 mb-2">Contract Line Items</h2>
            {% include "payment_certificate/tables/line_items.html" with grouped_line_items=grouped_line_items line_items_total=payment_certificate.contract_current_claim_total %}
        </div>
        <div id="addendum-line-items" class="mb-6 border-b border-gray-200">
            <h2 class="text-lg font-bold text-gray-900 mb-2">Addendum Line Items</h2>
            {% include "payment_certificate/tables/line_items.html" with grouped_line_items=addendum_line_items line_items_total=payment_certificate.addendum_current_claim_total %}
        </div>
        <div id="special-items"
             class="flex flex-col items-center justify-center gap-2 mb-6 border-b border-gray-200 mb-2">
            <h2 class="text-lg font-bold text-gray-900 mb-2 flex items-center gap-2">
                {% heroicon_outline "star" size="20" class="text-orange-600" %} Special Items
            </h2>
            {% include "payment_certificate/tables/special_items.html" with special_line_items=special_line_items special_line_items_total=payment_certificate.special_items_current_claim_total %}
        </div>
    </div>
{% endblock content %}
{% block extra_js %}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
          const statusUrl = "{% url 'bill_of_quantities:payment-certificate-pdf-status' project.pk payment_certificate.pk %}";
          
          // Independent polling for each PDF type
          const pdfPoller = {
              interval: null,
              isPolling: false,
              type: 'pdf'
          };
          
          const abridgedPdfPoller = {
              interval: null,
              isPolling: false,
              type: 'abridged_pdf'
          };
          
          // Check initial state and start polling if needed
          const pdfGenerating = {{ payment_certificate.pdf_generating|lower }};
          const abridgedPdfGenerating = {{ payment_certificate.abridged_pdf_generating|lower }};
          
          if (pdfGenerating) {
              console.log('Full PDF generation in progress, starting polling...');
              startPolling(pdfPoller);
          }
          
          if (abridgedPdfGenerating) {
              console.log('Abridged PDF generation in progress, starting polling...');
              startPolling(abridgedPdfPoller);
          }
          
          function startPolling(poller) {
              if (poller.isPolling) return; // Already polling
              
              poller.isPolling = true;
              // Poll every 2 seconds
              poller.interval = setInterval(() => checkStatus(poller), 2000);
          }
          
          function stopPolling(poller) {
              if (poller.interval) {
                  clearInterval(poller.interval);
                  poller.interval = null;
                  poller.isPolling = false;
                  console.log(`${poller.type} polling stopped`);
              }
          }
          
          async function checkStatus(poller) {
              try {
                  const response = await fetch(statusUrl);
                  const data = await response.json();
                  
                  console.log(`${poller.type} status update:`, data);
                  
                  if (poller.type === 'pdf') {
                      // Update full PDF status
                      updatePDFStatus('pdf', data.pdf_generating, data.pdf_available);
                      
                      // Stop polling if generation complete
                      if (!data.pdf_generating) {
                          stopPolling(poller);
                          // Reload page to show updated state

                      }
                  } else if (poller.type === 'abridged_pdf') {
                      // Update abridged PDF status
                      updatePDFStatus('abridged_pdf', data.abridged_pdf_generating, data.abridged_pdf_available);
                      
                      // Stop polling if generation complete
                      if (!data.abridged_pdf_generating) {
                          stopPolling(poller);
                          // Reload page to show updated state

                      }
                  }
              } catch (error) {
                  console.error(`Error checking ${poller.type} status:`, error);
              }
          }
          
          function updatePDFStatus(type, isGenerating, isAvailable) {
              const formSelector = type === 'pdf' ? 'form[action*="download-pdf"]:not([action*="abridged"])' : 'form[action*="download-abridged-pdf"]';
              const form = document.querySelector(formSelector);
              
              if (!form) return;
              
              const badgeContainer = form.querySelector('.flex.items-center.gap-2');
              const button = form.querySelector('button[type="submit"]');
              
              if (!badgeContainer || !button) return;
              
              // Remove existing badge
              const existingBadge = badgeContainer.querySelector('span.inline-flex.items-center');
              if (existingBadge) {
                  existingBadge.remove();
              }
              
              // Add new badge based on status
              let badgeHTML = '';
              if (isGenerating) {
                  badgeHTML = `
                      <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                          <svg class="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                          </svg>
                          Generating...
                      </span>
                  `;
                  button.disabled = true;
                  button.className = 'inline-flex items-center gap-2 px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-400 cursor-not-allowed transition-colors';
              } else if (isAvailable) {
                  badgeHTML = `
                      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                          ✓ Available
                      </span>
                  `;
                  button.disabled = false;
                  button.className = 'inline-flex items-center gap-2 px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors';
              } else {
                  badgeHTML = `
                      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                          Not generated
                      </span>
                  `;
                  button.disabled = false;
                  button.className = 'inline-flex items-center gap-2 px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors';
              }
              
              badgeContainer.insertAdjacentHTML('beforeend', badgeHTML);
          }
      });

      // Handle button text change when force regenerate checkbox is checked
      const forceFullCheckbox = document.getElementById('force-full-pdf');
      const fullButtonText = document.getElementById('full-pdf-button-text');
      const forceAbridgedCheckbox = document.getElementById('force-abridged-pdf');
      const abridgedButtonText = document.getElementById('abridged-pdf-button-text');

      if (forceFullCheckbox && fullButtonText) {
          forceFullCheckbox.addEventListener('change', function() {
              fullButtonText.textContent = this.checked ? 'Regenerate Payment Certificate' : 'Download';
          });
      }

      if (forceAbridgedCheckbox && abridgedButtonText) {
          forceAbridgedCheckbox.addEventListener('change', function() {
              abridgedButtonText.textContent = this.checked ? 'Regenerate Abridged Certificate' : 'Download';
          });
      }
    </script>
{% endblock extra_js %}
