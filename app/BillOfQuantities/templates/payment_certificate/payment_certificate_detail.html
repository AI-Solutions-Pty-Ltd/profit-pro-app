{% extends "base.html" %}
{% block title %}
  Payment Certificate - {{ project.name }}
{% endblock title %}
{% block content %}
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="bg-white shadow-sm rounded-lg mb-6">
      <div class="px-6 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ project.name }}</h1>
            <p class="text-sm text-gray-600 mt-1">Payment Certificate: #{{ payment_certificate.certificate_number }}</p>
            <p class="text-sm text-gray-600 mt-1">Status: {{ payment_certificate.status }}</p>
          </div>
          <div class="flex items-center space-x-3">
            <a href="{% url 'project:project-list' %}"
               class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              {% heroicon_outline "arrow-left" class="w-4 h-4 mr-2" %}
              Back to Projects
            </a>
            <a href="{% url 'bill_of_quantities:payment-certificate-list' project.pk %}"
               class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              {% heroicon_outline "arrow-left" class="w-4 h-4 mr-2" %}
              Back to Payment Certificates
            </a>
          </div>
        </div>
      </div>
    </div>
    <!-- actual transactions -->
    <div class="bg-white shadow-sm rounded-lg mb-6">
      <div class="px-6 py-4">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-lg font-bold text-gray-900">Actual Transactions</h2>
          </div>
          <div class="flex items-center space-x-3">
            {% if payment_certificate.status == "DRAFT" %}
              <a href="{% url 'bill_of_quantities:payment-certificate-edit' project.pk payment_certificate.pk %}"
                 class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                {% heroicon_outline "pencil" class="w-4 h-4 mr-2" %}
                Edit
              </a>
            {% endif %}
            {% if payment_certificate.actual_transactions.count %}
              {% if payment_certificate.status == 'DRAFT' or payment_certificate.status == 'REJECTED' %}
                <a href="{% url 'bill_of_quantities:payment-certificate-submit' project.pk payment_certificate.pk %}"
                   class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                  {% heroicon_outline "check" class="w-4 h-4 mr-2" %}
                  Submit Payment Certificate
                </a>
              {% endif %}
            {% endif %}
            {% if payment_certificate.status == 'SUBMITTED' %}
              <a href="{% url 'bill_of_quantities:payment-certificate-approve' project.pk payment_certificate.pk %}"
                 class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                {% heroicon_outline "check" class="w-4 h-4 mr-2" %}
                Final Payment Certificate Review
              </a>
            {% endif %}
          </div>
          <!-- show actual transactions -->
        </div>
        <!-- Transactions Table -->
        <div class="overflow-x-auto">
          {% if payment_certificate.actual_transactions.exists %}
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Structure</th>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bill</th>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Package</th>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item No.</th>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit</th>
                  <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Budgeted Qty</th>
                  <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Progressive Previous</th>
                  <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Progressive to Date</th>
                  <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">This Claim</th>
                  <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                  <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Price</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                {% for transaction in payment_certificate.actual_transactions.select_related %}
                  <tr class="hover:bg-gray-50">
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{{ transaction.line_item.structure.name }}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{{ transaction.line_item.bill.name }}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{{ transaction.line_item.package.name|default:"-" }}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{{ transaction.line_item.item_number|default:"-" }}</td>
                    <td class="px-3 py-2 text-sm text-gray-900">{{ transaction.line_item.description|truncatewords:10 }}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">
                      {{ transaction.line_item.unit_measurement|default:"-" }}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right">
                      {{ transaction.line_item.budgeted_quantity|floatformat:2|intcomma }}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right">
                      {{ transaction.line_item.claimed_to_date|floatformat:2|intcomma }}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-semibold text-indigo-600 text-right">
                      {{ transaction.line_item.claimed_to_date|add:transaction.quantity|floatformat:2|intcomma }}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-semibold text-indigo-600 text-right">
                      {{ transaction.quantity|floatformat:2|intcomma }}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right">
                      R {{ transaction.unit_price|floatformat:2|intcomma }}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-semibold text-gray-900 text-right">
                      R {{ transaction.total_price|floatformat:2|intcomma }}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
              <tfoot class="bg-gray-50">
                <tr>
                  <td colspan="11"
                      class="px-3 py-3 text-right text-sm font-bold text-gray-900">Total:</td>
                  <td class="px-3 py-3 whitespace-nowrap text-sm font-bold text-indigo-600 text-right">
                    R {{ total_amount|floatformat:2|intcomma }}
                  </td>
                </tr>
              </tfoot>
            </table>
          {% else %}
            <div class="text-center py-12">
              {% heroicon_outline "clipboard-document-list" class="w-12 h-12 mx-auto text-gray-400" %}
              <h3 class="mt-2 text-sm font-medium text-gray-900">No Transactions</h3>
              <p class="mt-1 text-sm text-gray-500">This payment certificate has no actual transactions yet.</p>
              <div class="mt-6">
                <a href="{% url 'bill_of_quantities:payment-certificate-edit' project.pk payment_certificate.pk %}"
                   class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                  {% heroicon_outline "plus" class="w-5 h-5 mr-2" %}
                  Add Transactions
                </a>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endblock content %}
{% block extra_js %}
  <script>
      document.addEventListener('DOMContentLoaded', function() {
          // Add any interactive features here
          console.log('Payment certificate detail loaded');
      });
  </script>
{% endblock extra_js %}
