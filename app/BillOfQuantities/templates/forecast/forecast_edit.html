{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block title %}
    Edit Forecast - {{ project.name }}
{% endblock title %}
{% block content %}
    <div class="container mx-auto px-4 py-8">
        <div class="mb-6">
            <nav class="text-sm text-gray-600">
                <a href="{% url 'project:project-detail' project.pk %}"
                   class="hover:text-blue-600">{{ project.name }}</a>
                <span class="mx-2">/</span>
                <a href="{% url 'bill_of_quantities:forecast-list' project.pk %}"
                   class="hover:text-blue-600">Forecasts</a>
                <span class="mx-2">/</span>
                <span class="text-gray-900">Edit Forecast - {{ forecast.period|date:"F Y" }}</span>
            </nav>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-900">Edit Forecast</h1>
                <div class="flex items-center space-x-2">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium {% if forecast.status == 'DRAFT' %}bg-yellow-100 text-yellow-800{% else %}bg-green-100 text-green-800{% endif %}">
                        {{ forecast.get_status_display }}
                    </span>
                    {% if forecast.status == 'DRAFT' %}
                        <a href="{% url 'bill_of_quantities:forecast-approve' project.pk forecast.pk %}"
                           class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            Approve Forecast
                        </a>
                    {% endif %}
                </div>
            </div>
            <div class="mb-4 text-sm text-gray-600">
                <p>
                    Period: <strong>{{ forecast.period|date:"F Y" }}</strong>
                </p>
                <p>
                    Captured by: <strong>{{ forecast.captured_by.get_full_name|default:forecast.captured_by.email }}</strong>
                </p>
                {% if forecast.approved_by %}
                    <p>
                        Approved by: <strong>{{ forecast.approved_by.get_full_name|default:forecast.approved_by.email }}</strong>
                    </p>
                {% endif %}
            </div>
            <!-- Filters Section -->
            <div id="filter-line-items"
                 class="bg-white shadow-md rounded-lg overflow-hidden mb-4 px-6 py-5">
                <h2 class="font-medium text-gray-900 mb-2">Forecast Transactions</h2>
                <div class="border-b border-gray-200">
                    <form method="get" id="filterForm">
                        <h3 class="text-sm font-medium text-gray-900 mb-2">Filters</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="structure" class="block text-sm font-medium text-gray-700 mb-1">Structure</label>
                                <select name="structure"
                                        id="structure"
                                        onchange="document.getElementById('filterForm').submit()"
                                        class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="">All Structures</option>
                                    {% for structure in structures %}
                                        <option value="{{ structure.id }}"
                                                {% if request.GET.structure == structure.id|stringformat:"s" %}selected{% endif %}>
                                            {{ structure.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="bill" class="block text-sm font-medium text-gray-700 mb-1">Bill</label>
                                <select name="bill"
                                        id="bill"
                                        onchange="document.getElementById('filterForm').submit()"
                                        class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="">All Bills</option>
                                    {% for bill in bills %}
                                        <option value="{{ bill.id }}"
                                                {% if request.GET.bill == bill.id|stringformat:"s" %}selected{% endif %}>
                                            {{ bill.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="package" class="block text-sm font-medium text-gray-700 mb-1">Package</label>
                                <select name="package"
                                        id="package"
                                        onchange="document.getElementById('filterForm').submit()"
                                        class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="">All Packages</option>
                                    {% for package in packages %}
                                        <option value="{{ package.id }}"
                                                {% if request.GET.package == package.id|stringformat:"s" %}selected{% endif %}>
                                            {{ package.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="description"
                                       class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <div class="flex gap-2">
                                    <input type="text"
                                           name="description"
                                           id="description"
                                           value="{{ request.GET.description }}"
                                           placeholder="Search description..."
                                           class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <button type="submit"
                                            class="inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                                        Search
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% if request.GET.structure or request.GET.bill or request.GET.package or request.GET.description %}
                            <div class="my-3">
                                <a href="{% url 'bill_of_quantities:forecast-edit' project.pk forecast.pk %}"
                                   class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                    Clear Filters
                                </a>
                            </div>
                        {% endif %}
                    </form>
                </div>
            </div>
            {% if forecast.status == 'DRAFT' %}
                <form method="post" id="forecast-form">
                    {% csrf_token %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="forecast-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Details</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Budgeted Quantity</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Budgeted Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Forecast Quantity</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Price</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for structure, structure_data in grouped_transactions.items %}
                                    {% if structure %}
                                        <tr class="structure-header bg-blue-50">
                                            <td colspan="7" class="px-6 py-3 text-sm font-semibold text-blue-900">Structure: {{ structure.name }}</td>
                                        </tr>
                                    {% endif %}
                                    {% for bill, bill_data in structure_data.items %}
                                        {% if bill %}
                                            <tr class="bill-header bg-green-50">
                                                <td colspan="7"
                                                    class="px-6 py-2 text-sm font-medium text-green-900 pl-12">
                                                    Bill: {{ bill.name }}
                                                </td>
                                            </tr>
                                        {% endif %}
                                        {% for package, transactions in bill_data.items %}
                                            {% if package %}
                                                <tr class="package-header bg-purple-50">
                                                    <td colspan="7"
                                                        class="px-6 py-2 text-sm font-medium text-purple-900 pl-20">
                                                        Package: {{ package.name }}
                                                    </td>
                                                </tr>
                                            {% endif %}
                                            {% for transaction in transactions %}
                                                <tr class="transaction-row"
                                                    data-structure="{{ transaction.line_item.structure.pk|default:'' }}"
                                                    data-structure-name="{{ transaction.line_item.structure.name|default:'' }}"
                                                    data-bill="{{ transaction.line_item.bill.pk|default:'' }}"
                                                    data-bill-name="{{ transaction.line_item.bill.name|default:'' }}"
                                                    data-package="{{ transaction.line_item.package.pk|default:'' }}"
                                                    data-package-name="{{ transaction.line_item.package.name|default:'' }}">
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                        <div>
                                                            <div class="font-medium">{{ transaction.line_item.item_number }}</div>
                                                            <div class="text-gray-500">{{ transaction.line_item.description|truncatechars:80 }}</div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ transaction.line_item.unit_measurement }}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ transaction.line_item.budgeted_quantity }}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                        R {{ transaction.line_item.total_price|default:0|floatformat:2|intcomma }}
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <input type="number"
                                                               name="quantity_{{ transaction.id }}"
                                                               id="quantity_{{ transaction.id }}"
                                                               value="{{ transaction.quantity }}"
                                                               step="0.01"
                                                               class="w-24 px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                               onchange="updateTotal({{ transaction.id }})">
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <input type="number"
                                                               name="unit_price_{{ transaction.id }}"
                                                               id="unit_price_{{ transaction.id }}"
                                                               value="{{ transaction.unit_price }}"
                                                               step="0.01"
                                                               class="w-24 px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                               onchange="updateTotal({{ transaction.id }})">
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                        <input type="number"
                                                               name="total_price_{{ transaction.id }}"
                                                               id="total_price_{{ transaction.id }}"
                                                               value="{{ transaction.total_price }}"
                                                               step="0.01"
                                                               readonly
                                                               class="w-28 px-2 py-1 bg-gray-50 border border-gray-300 rounded">
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        {% endfor %}
                                    {% endfor %}
                                {% endfor %}
                                {% if not grouped_transactions %}
                                    <tr>
                                        <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">No forecast transactions found.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                            <tfoot class="bg-gray-50">
                                <tr>
                                    <td colspan="5"
                                        class="px-6 py-3 text-right text-sm font-medium text-gray-900">
                                        Total Forecast:
                                    </td>
                                    <td colspan="2" class="px-6 py-3 text-sm font-bold text-gray-900">
                                        R <span id="grand-total">{{ forecast.total_forecast|floatformat:2|intcomma }}</span>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="flex items-center justify-between mt-6">
                        <a href="{% url 'bill_of_quantities:forecast-list' project.pk %}"
                           class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Cancel
                        </a>
                        <button type="submit"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Save Forecast
                        </button>
                    </div>
                </form>
            {% else %}
                <div class="bg-green-50 border border-green-200 rounded-md p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">{% heroicon_outline 'check-circle' %}</div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-green-800">Forecast Approved</h3>
                            <div class="mt-2 text-sm text-green-700">
                                <p>This forecast has been approved and cannot be edited.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <a href="{% url 'bill_of_quantities:forecast-list' project.pk %}"
                       class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Back to Forecasts
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    <script>
    function updateTotal(transactionId) {
        const quantity = parseFloat(document.getElementById(`quantity_${transactionId}`).value) || 0;
        const unitPrice = parseFloat(document.getElementById(`unit_price_${transactionId}`).value) || 0;
        const total = quantity * unitPrice;
        
        document.getElementById(`total_price_${transactionId}`).value = total.toFixed(2);
    }
    </script>
{% endblock content %}
