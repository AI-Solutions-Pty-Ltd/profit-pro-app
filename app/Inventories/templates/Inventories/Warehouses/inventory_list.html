{% extends "base.html" %}
{% load l10n %}
{% block content %}
    <!-- Breadcrumb Navigation -->
    <div id="breadcrumb" class="no-print mb-6">
        <nav aria-label="breadcrumb" class="text-sm">
            <ol class="flex items-center space-x-2">
                <li class="breadcrumb-item">
                    <a href="{% url 'home' %}"
                       class="text-blue-600 hover:text-blue-800 transition-colors">Home</a>
                </li>
                {% if object %}
                    <li class="breadcrumb-item">
                        <a href="{% url 'inventories:inventory_list_view' %}"
                           class="text-blue-600 hover:text-blue-800 transition-colors">All Inventories</a>
                    </li>
                {% endif %}
                <li class="breadcrumb-item">
                    <a href="{% url 'inventories:warehouse_list_view' %}"
                       class="text-blue-600 hover:text-blue-800 transition-colors">Warehouse List</a>
                </li>
                <li class="breadcrumb-item">
                    <button onclick="openModal('create_inventory')"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 font-medium text-sm">
                        Add Inventory
                    </button>
                </li>
                <li class="breadcrumb-item">
                    <button onclick="openModal('create_transaction')"
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 font-medium text-sm">
                        Inventory Transaction
                    </button>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'inventories:inventory_tx_list_view' %}"
                       class="text-blue-600 hover:text-blue-800 transition-colors">Inventory Transactions</a>
                </li>
                <li class="breadcrumb-item text-gray-600 font-medium" aria-current="page">{{ title }}</li>
            </ol>
        </nav>
    </div>
    <!-- Inventory List with Filtering -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <form method="post" class="p-6">
            {% csrf_token %}
            <div class="overflow-x-auto">
                <table class="w-full" style="max-width:100%;">
                    <thead>
                        <tr class="border-b-2 border-gray-200">
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Inventory item</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Type</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Warehouse</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Quantity</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Active</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 no-print">Action</th>
                        </tr>
                        <tr class="border-b border-gray-100 bg-gray-50 no-print">
                            <th class="py-3 px-4">{{ form_filter.description }}</th>
                            <th class="py-3 px-4">{{ form_filter.type }}</th>
                            <th class="py-3 px-4">{{ form_filter.warehouse }}</th>
                            <th colspan="3" class="py-3 px-4 text-right">
                                <input class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 font-medium cursor-pointer"
                                       type="submit"
                                       value="Apply Filter"
                                       name="filter">
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for instance in queryset %}
                            <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                                <td class="py-3 px-4 text-gray-800">{{ instance.description }}</td>
                                <td class="py-3 px-4 text-gray-800">{{ instance.type__description }}</td>
                                <td class="py-3 px-4 text-gray-800">{{ instance.inventorytransaction__warehouse__description }}</td>
                                <td class="py-3 px-4 text-gray-800">{{ instance.sum }}</td>
                                <td class="py-3 px-4 text-gray-800">{{ instance.active__description }}</td>
                                <td class="py-3 px-4 no-print">
                                    <div class="flex space-x-2">
                                        <button type="button"
                                                onclick="populate('{{ instance.description }}', '{{ instance.type__description }}', '{{ instance.active__description }}', '{{ instance.id|unlocalize }}'); openModal('edit_inventory')"
                                                class="bg-blue-100 hover:bg-blue-200 text-blue-700 p-2 rounded-lg transition-colors duration-200"
                                                title="Edit Inventory">
                                            {% heroicon_outline "pencil" class="w-4 h-4" %}
                                        </button>
                                        <a href="{% url 'inventories:inventory_tx_list_view' %}"
                                           class="bg-green-100 hover:bg-green-200 text-green-700 p-2 rounded-lg transition-colors duration-200 inline-block"
                                           title="View Transactions">{% heroicon_outline "eye" class="w-4 h-4" %}</a>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    </div>
    <!-- Create Inventory Modal -->
    <div id="create_inventory"
         class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Create New Inventory Item</h3>
                <button type="button"
                        onclick="closeModal('create_inventory')"
                        class="text-gray-400 hover:text-gray-600 transition-colors p-2 hover:bg-gray-100 rounded-lg">
                    <span class="material-icons">&times;</span>
                </button>
            </div>
            <div class="p-6">
                <form method='POST'>
                    {% csrf_token %}
                    <div class="space-y-4">
                        <div class="text-center text-lg font-semibold text-gray-800">{{ title }}</div>
                        {% for field in form %}
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                                <label class="text-sm font-medium text-gray-700">{{ field.label }}</label>
                                <div class="md:col-span-2">{{ field }}</div>
                            </div>
                        {% endfor %}
                        <div class="flex justify-center pt-4">
                            <button type='submit'
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors duration-200 font-semibold"
                                    name="create inventory">Create Inventory Item</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="flex justify-end p-6 border-t border-gray-200">
                <button type="button"
                        onclick="closeModal('create_inventory')"
                        class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>
    <!-- Create Inventory Transaction Modal -->
    <div id="create_transaction"
         class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Create New Inventory Transaction</h3>
                <button type="button"
                        onclick="closeModal('create_transaction')"
                        class="text-gray-400 hover:text-gray-600 transition-colors p-2 hover:bg-gray-100 rounded-lg">
                    <span class="material-icons">&times;</span>
                </button>
            </div>
            <div class="p-6">
                <form method='POST' onsubmit="validate();">
                    {% csrf_token %}
                    <div class="space-y-4">
                        <div class="text-center text-lg font-semibold text-gray-800">{{ title }}</div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                            <label class="text-sm font-medium text-gray-700">Date</label>
                            <div class="md:col-span-2">{{ form_movement.date }}</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                            <label class="text-sm font-medium text-gray-700">Type</label>
                            <div class="md:col-span-2" id="input_type">{{ form_movement.type }}</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                            <label class="text-sm font-medium text-gray-700">Inventory</label>
                            <div class="md:col-span-2">{{ form_movement.inventory }}</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                            <label class="text-sm font-medium text-gray-700">Warehouse</label>
                            <div class="md:col-span-2" id="input_from_warehouse">{{ form_movement.warehouse }}</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                            <label class="text-sm font-medium text-gray-700">Qty</label>
                            <div class="md:col-span-2">{{ form_movement.qty }}</div>
                        </div>
                        <div id="tr_to_warehouse"
                             class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                            <label class="text-sm font-medium text-gray-700">To Warehouse</label>
                            <div class="md:col-span-2" id="input_to_warehouse">{{ form_movement.to_warehouse }}</div>
                        </div>
                        <div class="flex justify-center pt-4">
                            <button type='submit'
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors duration-200 font-semibold"
                                    name="create transaction">Create Inventory Transaction</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="flex justify-end p-6 border-t border-gray-200">
                <button type="button"
                        onclick="closeModal('create_transaction')"
                        class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>
    <!-- Edit Inventory Modal -->
    <div id="edit_inventory"
         class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Edit Inventory Item</h3>
                <button type="button"
                        onclick="closeModal('edit_inventory')"
                        class="text-gray-400 hover:text-gray-600 transition-colors p-2 hover:bg-gray-100 rounded-lg">
                    <span class="material-icons">&times;</span>
                </button>
            </div>
            <div class="p-6">
                <form method='POST'>
                    {% csrf_token %}
                    <div class="space-y-4">
                        <div class="text-center text-lg font-semibold text-gray-800">{{ instance.description }}</div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                            <label class="text-sm font-medium text-gray-700">Description</label>
                            <div class="md:col-span-2" name="description_input">{{ form.description }}</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                            <label class="text-sm font-medium text-gray-700">Type</label>
                            <div class="md:col-span-2" name="type_input">{{ form.type }}</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                            <label class="text-sm font-medium text-gray-700">Active</label>
                            <div class="md:col-span-2" name="active_input">{{ form.active }}</div>
                        </div>
                        <div class="flex justify-center pt-4">
                            <button id="input_inventory"
                                    type='submit'
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors duration-200 font-semibold"
                                    name="edit inventory-xx">Save Inventory Item</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="flex justify-end p-6 border-t border-gray-200">
                <button type="button"
                        onclick="closeModal('edit_inventory')"
                        class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>
    {# Edit Inventory MODAL per instance #}
    <script>
    // Modal control functions for Tailwind modals
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = 'auto';
        }
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('fixed') && event.target.classList.contains('inset-0')) {
            const modalId = event.target.id;
            if (modalId) {
                closeModal(modalId);
            }
        }
    });

    // Populate edit modal with inventory data
    function populate(x, y, z, id) {
        var input, input2, input_btn = '';

        var myInput1 = document.getElementsByName('description_input');
        var myInput2 = document.getElementsByName('type_input');
        var myInput3 = document.getElementsByName('active_input');
        var input_btn = document.getElementById('input_inventory');

        input_btn.name = 'edit inventory'+id
        myInput1[0].childNodes[0].value = x;
        myInput1[0].childNodes[0].focus();
        for (var i = 0; i < myInput2[0].childNodes[0].length; i++){
            var option = myInput2[0].childNodes[0].options[i];
            if (option.text == y) {
                myInput2[0].childNodes[0].selectedIndex = i;
            }
        }

        for (var i = 0; i < myInput3[0].childNodes[0].length; i++){
            var option = myInput3[0].childNodes[0].options[i];
            if (option.text == z) {
                myInput3[0].childNodes[0].selectedIndex = i;
            }
        }
    }

    // Warehouse update function for transaction modal
    function warehouse_update() {   
        const type = document.querySelector("#input_type").childNodes[0].selectedIndex;
        const tr_to_warehouse = document.querySelector("#tr_to_warehouse");

        const from_warehouse = document.querySelector("#input_from_warehouse").childNodes[0];
        const to_warehouse = document.querySelector("#input_to_warehouse").childNodes[0];

        if (type == 2) {
            tr_to_warehouse.classList.remove('hidden');
            for (var i = to_warehouse.length-1; i >= 0; i--) {
                to_warehouse.options[i] = null;
            }

            for (var i = 0; i < from_warehouse.length; i++) {
                var option = document.createElement("option");
                option.value = i;
                option.innerHTML = from_warehouse.options[i].text;
                to_warehouse.appendChild(option);
            }
        }
        else {
            tr_to_warehouse.classList.add('hidden');
        }
    }

    // Form validation function
    function validate() {
        var table = document.getElementById('order_table');
        if (!table) {
            // If order_table doesn't exist, allow form submission for inventory transaction
            return true;
        }
        
        var tBodies = table.tBodies[0];
        var row;
        var qty_total = 0;
        var qty_delivered = 0;
        var qty_returned = 0;
        var total = 0;
        var b = true;

        for (i = 0; i < tBodies.rows.length; i++) {
            row = tBodies.rows[i];
            qty_total = parseFloat(row.cells[2].innerText);
            qty_delivered = parseFloat(row.cells[3].childNodes[0].value);
            qty_returned = parseFloat(row.cells[4].childNodes[0].value);
            total += qty_delivered + qty_returned;
            if (isNaN(qty_delivered) || qty_delivered < 0) {
                qty_delivered = 0;
                row.cells[3].childNodes[0].value = 0;
            }

            if (isNaN(qty_returned) || qty_returned < 0) {
                qty_returned = 0;
                row.cells[4].childNodes[0].value = 0;
            }

            if (qty_total < (qty_delivered + qty_returned)) {
                alert('aborting submit');
                b = false;
            }
        }
        if (total == 0) {
            alert('No units added');
            event.preventDefault()
        }

        if (b == false) {
            event.preventDefault()
        }
    }

    // Initialize warehouse update listener
    document.addEventListener('DOMContentLoaded', function() {
        const typeSelect = document.querySelector("#input_type");
        if (typeSelect) {
            typeSelect.addEventListener('change', warehouse_update);
        }
    });
    </script>
{% endblock %}
