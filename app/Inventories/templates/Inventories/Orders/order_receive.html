{% extends "base.html" %}
{% load l10n %}
{% block content %}
    <div id="breadcrumb" class="row col-md-6 no-print">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href={% url 'home' %}>Home</a>
                </li>
                <li class="breadcrumb-item">
                    <a href={% url 'inventories:order_list_view' %}>All Orders</a>
                </li>
                {% if order %}
                    <li class="breadcrumb-item">
                        <a href={% url 'inventories:order_composition_view' order=order.id %}>Order Composition</a>
                    </li>
                {% endif %}
                <li class="breadcrumb-item active" aria-current="page">{{ title }}</li>
            </ol>
        </nav>
    </div>
    <div class="">
        <form class="row col-md-6" method="post">
            {% csrf_token %}
            <table class="table">
                <tr>
                    <th colspan="2">Enter Purchase Order Number</th>
                </tr>
                <tr>
                    <th>{{ form_order.purchase_order }}</th>
                    <th>
                        <input class="btn btn-primary" type="submit" value="Go to purchase order" name="filter"
                        </th>
                    </tr>
                </table>
            </form>
        </div>
        <br />
        {% if order %}
            <div class="">
                <form class="row col-sm-3 col-md-6 col-lg-12"
                      method='POST'
                      onsubmit="validate();">
                    {% csrf_token %}
                    {{ deliverorderformset.management_form }}
                    <table id="order_table" class="table tabel-bordered">
                        <thead>
                            <tr>
                                <th colspan="2">
                                    {{ title }}
                                    <a class="btn btn-success"
                                       href="{% url 'inventories:order_receive_view' order=order.id %}">Re-Load Order</a>
                                </th>
                            </tr>
                            <tr>
                                <th colspan="2">Order: PO-{{ order.id|stringformat:"05d" }}</th>
                            </tr>
                            <tr>
                                <td colspan="2">Supplier: {{ order.supplier.description }}</td>
                            </tr>
                            <tr>
                                <td colspan="2">Date: {{ order.date|date:"Y/m/d" }}</td>
                            </tr>
                            <tr>
                                <th>Inventory</th>
                                <th>Warehouse</th>
                                <th>Qty Remaining</th>
                                <th>Qty Received</th>
                                <th>Qty Returned</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for instance in order_composition %}
                                <tr>
                                    <td>{{ instance.inventory }}</td>
                                    <td>{{ instance.warehouse }}</td>
                                    <td>
                                        {{ instance.sum|unlocalize }}
                                        {% if instance.sum > 0 %}
                                            <button class="btn btn-small btn-success"
                                                    onclick="maxDelivery({{ instance.id|unlocalize }}, {{ instance.sum|unlocalize }});">
                                                Max
                                            </button>
                                        {% endif %}
                                    </td>
                                    {% if instance.sum > 0 %}
                                        {% for form in deliverorderformset %}
                                            {% if form.id.value == instance.id %}
                                                {{ form.id }}
                                                <td id="inputDelivered-{{ instance.id|unlocalize }}">{{ form.qty_delivered }}</td>
                                                <td>{{ form.qty_returned }}</td>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <td></td>
                                        <td></td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <input class="btn btn-primary"
                           type='submit'
                           value='Goods Delivered'
                           style="font:bold"
                           name="receive order" />
                </form>
            </div>
        {% endif %}
        <script>
    window.onload = onLoad();

    function maxDelivery(id, max) {
        event.preventDefault()
        var input = document.getElementById('inputDelivered-'+id).childNodes[0]
        input.value = max
    }
    function onLoad() {
        var table = document.getElementById('order_table');
        var tBodies = table.tBodies[0];
        var row;
        for (i = 0; i < tBodies.rows.length; i++) {
            row = tBodies.rows[i];
            try {
                row.cells[3].childNodes[0].value = 0;
            }
            catch {
                console.log("none")
            }
            try {
                row.cells[4].childNodes[0].value = 0;
            }
            catch {
                console.log("none")
            }
        }
    }

    function findTotal(x) {
        var table = document.getElementById('order_table');
        var tBodies = table.tBodies[0];
        var row;
        var qty_total;
        var qty_delivered;
        var qty_returned;

        for (i = 0; i < tBodies.rows.length; i++) {
            row = tBodies.rows[i];
            qty_total = parseFloat(row.cells[2].innerText);
            qty_delivered = parseFloat(row.cells[3].childNodes[0].value);
            qty_returned = parseFloat(row.cells[4].childNodes[0].value);

            if (isNaN(qty_delivered) || qty_delivered < 0) {
                qty_delivered = 0;
                row.cells[3].childNodes[0].value = 0;
            }

            if (isNaN(qty_returned) || qty_returned < 0) {
                qty_returned = 0;
                row.cells[4].childNodes[0].value = 0;
            }

            if (qty_total < (qty_delivered + qty_returned)) {
                row.cells[3].childNodes[0].value = 0;
                row.cells[4].childNodes[0].value = 0;
                alert("Cannot receive/return more than ordered");
                if (x == 1) {
                    return false;
                }
            }
            else {
                if (x == 1) {
                    return true;
                }
            }
        }
    }

    function validate() {
        var table = document.getElementById('order_table');
        var tBodies = table.tBodies[0];
        var row;
        var qty_total = 0;
        var qty_delivered = 0;
        var qty_returned = 0;
        var total = 0;
        var b = true;

        for (i = 0; i < tBodies.rows.length; i++) {
            try {
                row = tBodies.rows[i];
                qty_total = parseFloat(row.cells[2].innerText);
                qty_delivered = parseFloat(row.cells[3].childNodes[0].value);
                qty_returned = parseFloat(row.cells[4].childNodes[0].value);
                total += qty_delivered + qty_returned;
                if (isNaN(qty_delivered) || qty_delivered < 0) {
                    qty_delivered = 0;
                    row.cells[3].childNodes[0].value = 0;
                }

                if (isNaN(qty_returned) || qty_returned < 0) {
                    qty_returned = 0;
                    row.cells[4].childNodes[0].value = 0;
                }

                if (qty_total < (qty_delivered + qty_returned)) {
                    alert('aborting submit');
                    b = false;
                }
            }
            catch {
                console.log("none")
            }
        }
        if (total == 0) {
            alert('No units added');
            event.preventDefault()
        }

        if (b == false) {
            event.preventDefault()
        }
    }

        </script>
    {% endblock %}
