{% extends "base.html" %}
{% load heroicons %}
{% block title %}
    Add Multiple Costs - {{ bill.name }}
{% endblock title %}
{% block content %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Banner -->
        <div class="bg-white shadow-sm rounded-lg mb-6">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Add Multiple Costs</h1>
                        <p class="text-sm text-gray-600 mt-1">{{ structure.name }} â€¢ {{ bill.name }}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button type="button"
                                onclick="addRow()"
                                class="inline-flex items-center gap-2 px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            {% heroicon_outline "plus" class="w-4 h-4" %}
                            Add Row
                        </button>
                        <button type="button"
                                onclick="delRow()"
                                class="inline-flex items-center gap-2 px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            {% heroicon_outline "minus" class="w-4 h-4" %}
                            Remove Row
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Form -->
        <div class="bg-white shadow-sm rounded-lg overflow-hidden">
            <form method="post" class="p-6" onsubmit="return validate()">
                {% csrf_token %}
                {{ formset.management_form }}
                <div class="overflow-x-auto">
                    <table id="order_table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for form in formset %}
                                <tr>
                                    <td class="px-4 py-3 whitespace-nowrap">{{ form.date }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap">{{ form.category }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap">{{ form.description }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap">{{ form.quantity }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap">{{ form.unit_price }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <button type="button"
                                                onclick="deleteRow(this)"
                                                class="inline-flex items-center p-2 border border-transparent rounded-md text-red-600 hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                                                title="Delete row">
                                            {% heroicon_outline "trash" class="h-4 w-4" %}
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="flex items-center justify-between pt-6 border-t border-gray-200 mt-6">
                    <div class="text-sm text-gray-500">
                        <p>Tip: VAT and totals will be calculated automatically based on the project settings.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <a href="{% url 'cost:bill-cost-detail' project.pk bill.pk %}"
                           class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Cancel
                        </a>
                        <button type="submit"
                                class="inline-flex items-center gap-2 px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            {% heroicon_outline "check" class="w-5 h-5" %}
                            Save All Costs
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <script>
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            updateManagementForm();
        });

        function updateManagementForm() {
            var table = document.getElementById('order_table');
            if (!table || !table.tBodies || !table.tBodies[0]) return;
            
            var totalForms = document.querySelector('input[name="form-TOTAL_FORMS"]');
            if (totalForms) {
                totalForms.value = table.tBodies[0].rows.length;
            }
        }

        function addRow() {
            var table = document.getElementById('order_table');
            if (!table || !table.tBodies || !table.tBodies[0]) {
                console.log('Table or tbody not found');
                return;
            }
            
            var tBodies = table.tBodies[0];
            if (tBodies.rows.length === 0) {
                console.log('No rows found to clone');
                return;
            }
            
            var node = tBodies.rows[0].cloneNode(true);
            tBodies.appendChild(node);

            var num_rows = tBodies.rows.length;
            var row = tBodies.rows[num_rows - 1];
            
            // Clear all input values
            var inputs = row.querySelectorAll('input, select');
            inputs.forEach(function(input) {
                if (input.type === 'checkbox') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });

            // Update form names and IDs
            var num = num_rows - 1;
            var dateInput = row.cells[0] ? row.cells[0].querySelector('input') : null;
            var categorySelect = row.cells[1] ? row.cells[1].querySelector('select') : null;
            var descriptionInput = row.cells[2] ? row.cells[2].querySelector('input') : null;
            var quantityInput = row.cells[3] ? row.cells[3].querySelector('input') : null;
            var unitPriceInput = row.cells[4] ? row.cells[4].querySelector('input') : null;
            
            // Update DELETE field name for formset
            var deleteInput = row.querySelector('input[name*="DELETE"]');
            if (deleteInput) {
                deleteInput.name = 'form-' + num + '-DELETE';
                deleteInput.id = 'id_form-' + num + '-DELETE';
            }
            
            if (dateInput) {
                dateInput.name = 'form-' + num + '-date';
                dateInput.id = 'id_form-' + num + '-date';
            }
            if (categorySelect) {
                categorySelect.name = 'form-' + num + '-category';
                categorySelect.id = 'id_form-' + num + '-category';
            }
            if (descriptionInput) {
                descriptionInput.name = 'form-' + num + '-description';
                descriptionInput.id = 'id_form-' + num + '-description';
            }
            if (quantityInput) {
                quantityInput.name = 'form-' + num + '-quantity';
                quantityInput.id = 'id_form-' + num + '-quantity';
            }
            if (unitPriceInput) {
                unitPriceInput.name = 'form-' + num + '-unit_price';
                unitPriceInput.id = 'id_form-' + num + '-unit_price';
            }
            
            updateManagementForm();
        }

        function deleteRow(btn) {
            var row = btn.closest('tr');
            if (row) {
                var deleteInput = row.querySelector('input[name*="DELETE"]');
                if (deleteInput) {
                    deleteInput.checked = true;
                    row.style.display = 'none';
                } else {
                    row.remove();
                }
                updateManagementForm();
            }
        }

        function delRow() {
            var table = document.getElementById('order_table');
            if (!table || !table.tBodies || !table.tBodies[0]) return;
            
            var rows = table.tBodies[0].rows;
            if (rows.length > 1) {
                var lastRow = rows[rows.length - 1];
                var deleteInput = lastRow.querySelector('input[name*="DELETE"]');
                if (deleteInput) {
                    deleteInput.checked = true;
                    lastRow.style.display = 'none';
                } else {
                    lastRow.remove();
                }
                updateManagementForm();
            }
        }

        function validate() {
            // Basic validation - ensure at least one row has data
            var table = document.getElementById('order_table');
            if (!table || !table.tBodies || !table.tBodies[0]) return true;
            
            var rows = table.tBodies[0].rows;
            var hasData = false;
            
            for (var i = 0; i < rows.length; i++) {
                if (rows[i].style.display === 'none') continue;
                
                var inputs = rows[i].querySelectorAll('input[type="number"], input[type="text"], select');
                for (var j = 0; j < inputs.length; j++) {
                    if (inputs[j].value && inputs[j].value.trim() !== '') {
                        hasData = true;
                        break;
                    }
                }
                if (hasData) break;
            }
            
            if (!hasData) {
                alert('Please enter at least one cost before saving.');
                return false;
            }
            
            return true;
        }
    </script>
    <!-- Footer -->
    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 rounded-lg mt-6">
        <div class="flex justify-between items-center">
            <a href="{% url 'cost:bill-cost-detail' project.pk bill.pk %}"
               class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-indigo-600 transition-colors">
                {% heroicon_outline "chevron-left" class="w-4 h-4 mr-1" %}
                Back to {{ bill.name }}
            </a>
            <a href="{% url 'cost:project-cost-tree' project.pk %}"
               class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-indigo-600 transition-colors">
                Cost Management
                {% heroicon_outline "chevron-right" class="w-4 h-4 ml-1" %}
            </a>
        </div>
    </div>
{% endblock content %}
