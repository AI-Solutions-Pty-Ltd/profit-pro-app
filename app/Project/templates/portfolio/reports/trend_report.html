{% extends "base_full.html" %}
{% load humanize %}
{% load static %}
{% load heroicons %}
{% block content %}
    <!-- Dashboard Navigation Tabs -->
    <div class="bg-white rounded-lg shadow-sm mb-6 sticky top-0 z-10">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8 px-6" aria-label="Dashboard tabs">
                <a href="{% url 'project:portfolio-trend-report' %}"
                   class="border-b-2 border-indigo-500 py-4 px-1 text-sm font-medium text-indigo-600">
                    {% heroicon_outline "chart-bar-square" class="w-5 h-5 inline mr-2" %}
                    Trend Analysis
                </a>
                <a href="{% url 'project:portfolio-dashboard' %}"
                   class="border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors">
                    {% heroicon_outline "chart-bar" class="w-5 h-5 inline mr-2" %}
                    Portfolio Dashboard
                </a>
                <a href="{% url 'project:portfolio-financial-report' %}"
                   class="border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors">
                    {% heroicon_outline "banknotes" class="w-5 h-5 inline mr-2" %}
                    Financial Report
                </a>
                <a href="{% url 'project:portfolio-schedule-report' %}"
                   class="border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors">
                    {% heroicon_outline "clock" class="w-5 h-5 inline mr-2" %}
                    Schedule Report
                </a>
                <a href="{% url 'project:portfolio-cashflow-report' %}"
                   class="border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors">
                    {% heroicon_outline "currency-dollar" class="w-5 h-5 inline mr-2" %}
                    Cashflow Report
                </a>
            </nav>
        </div>
    </div>
    <!-- Header -->
    <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Trend Analysis</h1>
            <p class="mt-2 text-gray-600">12-Month Performance Trends as of {{ current_date|date:"F d, Y" }}</p>
        </div>
        <div class="flex items-center gap-3">
            <!-- Filters -->
            <form id="filterForm" method="get" class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-600 whitespace-nowrap">Filter by:</label>
                <!-- Category Filter -->
                <select name="category"
                        id="id_category"
                        onchange="this.form.submit()"
                        class="block w-40 py-2 px-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                    <option value="">All Categories</option>
                    {% for category in filter_form.category.field.queryset %}
                        <option value="{{ category.pk }}"
                                {% if filter_form.category.value|stringformat:"s" == category.pk|stringformat:"s" %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
                <!-- Project Filter -->
                <select name="projects"
                        id="id_projects"
                        onchange="this.form.submit()"
                        class="block w-40 py-2 px-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                    <option value="">All Projects</option>
                    {% for project in filter_form.projects.field.queryset %}
                        <option value="{{ project.pk }}"
                                {% if filter_form.projects.value|stringformat:"s" == project.pk|stringformat:"s" %}selected{% endif %}>
                            {{ project.name }}
                        </option>
                    {% endfor %}
                </select>
                <!-- Consultant Filter -->
                <select name="consultant"
                        id="id_consultant"
                        onchange="this.form.submit()"
                        class="block w-40 py-2 px-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                    <option value="">All Consultants</option>
                    {% for consultant in filter_form.consultant.field.queryset %}
                        <option value="{{ consultant.pk }}"
                                {% if filter_form.consultant.value|stringformat:"s" == consultant.pk|stringformat:"s" %}selected{% endif %}>
                            {{ consultant.get_full_name|default:consultant.email }}
                        </option>
                    {% endfor %}
                </select>
                {% if filter_form.category.value or filter_form.projects.value or filter_form.consultant.value %}
                    <a href="{% url 'project:portfolio-trend-report' %}"
                       class="inline-flex items-center px-2 py-2 text-gray-500 hover:text-gray-700 transition-colors"
                       title="Clear filters">{% heroicon_outline "x-mark" size="18" %}</a>
                {% endif %}
            </form>
            {% if filter_form.projects.value %}
                <a href="{% url 'project:project-management' filter_form.projects.value %}"
                   class="inline-flex items-center px-3 py-2 border border-indigo-300 text-sm font-medium rounded-md text-indigo-700 bg-indigo-50 hover:bg-indigo-100 transition-colors"
                   title="Go to Project Management">
                    {% heroicon_outline "cog-6-tooth" size="16" class="mr-1" %}
                    Manage Project
                </a>
            {% endif %}
        </div>
    </div>
    <!-- Trend Chart -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4">
            <h5 class="text-lg font-semibold text-white flex items-center">
                {% heroicon_outline "chart-bar-square" size="24" class="mr-3" %}
                Planned vs Actual vs Forecast vs Budget (12 Months)
            </h5>
            <p class="text-indigo-100 text-sm mt-1">Monthly comparison of planned, actual, forecast, and budget values</p>
        </div>
        <div class="p-6">
            <div class="h-96">
                <canvas id="cashflowChart"></canvas>
            </div>
            <div class="flex flex-wrap justify-center gap-6 mt-6 text-sm">
                <div class="flex items-center">
                    <span class="w-4 h-4 rounded-full bg-blue-500 mr-2"></span>
                    <span class="font-medium text-gray-700">Planned</span>
                </div>
                <div class="flex items-center">
                    <span class="w-4 h-4 rounded-full bg-green-500 mr-2"></span>
                    <span class="font-medium text-gray-700">Actual</span>
                </div>
                <div class="flex items-center">
                    <span class="w-4 h-4 rounded-full bg-amber-500 mr-2"></span>
                    <span class="font-medium text-gray-700">Forecast</span>
                </div>
                <div class="flex items-center">
                    <span class="w-4 h-4 rounded-full bg-gray-400 mr-2"></span>
                    <span class="font-medium text-gray-700">Budget</span>
                </div>
            </div>
        </div>
    </div>
    <!-- Legend / Explanation -->
    <div class="bg-white rounded-lg shadow p-6">
        <h6 class="text-sm font-semibold text-gray-900 mb-3">Understanding the Trend Chart</h6>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
            <div class="flex items-start">
                <span class="w-3 h-3 rounded-full bg-blue-500 mr-2 mt-1"></span>
                <div>
                    <strong class="text-gray-800">Planned</strong>: The scheduled value of work to be completed each month based on the project baseline.
                </div>
            </div>
            <div class="flex items-start">
                <span class="w-3 h-3 rounded-full bg-green-500 mr-2 mt-1"></span>
                <div>
                    <strong class="text-gray-800">Actual</strong>: The actual cost incurred from approved payment certificates.
                </div>
            </div>
            <div class="flex items-start">
                <span class="w-3 h-3 rounded-full bg-amber-500 mr-2 mt-1"></span>
                <div>
                    <strong class="text-gray-800">Forecast</strong>: The projected cost based on current progress and remaining work.
                </div>
            </div>
            <div class="flex items-start">
                <span class="w-3 h-3 rounded-full bg-gray-400 mr-2 mt-1"></span>
                <div>
                    <strong class="text-gray-800">Budget</strong>: The monthly allocation from the total original budget (evenly distributed).
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Cashflow Chart Data (12 months)
            const cashflowLabels = {{ cashflow_labels|safe }};
            const plannedData = {{ planned_data|safe }};
            const actualData = {{ actual_data|safe }};
            const forecastData = {{ forecast_data|safe }};
            const budgetData = {{ budget_data|safe }};

            // Cashflow Chart (Planned vs Actual vs Forecast vs Budget)
            const cashflowCtx = document.getElementById('cashflowChart').getContext('2d');
            new Chart(cashflowCtx, {
                type: 'line',
                data: {
                    labels: cashflowLabels,
                    datasets: [{
                        label: 'Planned',
                        data: plannedData,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: false,
                        borderWidth: 3,
                        spanGaps: true
                    }, {
                        label: 'Actual',
                        data: actualData,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: false,
                        borderWidth: 3,
                        spanGaps: true
                    }, {
                        label: 'Forecast',
                        data: forecastData,
                        borderColor: 'rgb(245, 158, 11)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: false,
                        borderWidth: 3,
                        borderDash: [5, 5],
                        spanGaps: true
                    }, {
                        label: 'Budget',
                        data: budgetData,
                        borderColor: 'rgb(156, 163, 175)',
                        backgroundColor: 'rgba(156, 163, 175, 0.1)',
                        fill: false,
                        borderWidth: 2,
                        borderDash: [3, 3],
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14 },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    if (value === null) return 'No data';
                                    return `${context.dataset.label}: R ${value.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 12 }, maxRotation: 45, minRotation: 45 }
                        },
                        y: {
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            ticks: {
                                font: { size: 12 },
                                callback: function(value) {
                                    return 'R ' + value.toLocaleString();
                                }
                            },
                            beginAtZero: true
                        }
                    },
                    elements: {
                        point: { radius: 4, hoverRadius: 6 },
                        line: { tension: 0.3 }
                    }
                }
            });
        });
    </script>
{% endblock content %}
